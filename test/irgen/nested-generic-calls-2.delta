// RUN: %delta -print-ir %s | %FileCheck %s
// RUN: %delta -print-ir %s | %FileCheck %s -check-prefix=CHECK-M

interface I {
    def i();
}

struct S: Copyable {
    var i: int;
    init() {}
    def i() {}
}

struct A<E> {
    init() {}

    // CHECK: define %S @{{.*A.*S.*a.*}}({}* %this)
    def a(): E {
        // CHECK-NEXT: %1 = alloca %S
        // CHECK-NEXT: call void @_ENM4main1S4initE(%S* %1)
        // CHECK-NEXT: %2 = load %S, %S* %1
        // CHECK-NEXT: ret %S %2
        return E();
    }
}

struct M<T: I> {
    var t: T;

    init() {}

    // CHECK-M: define void @_EN4main1MI1SE1fE(%"M<S>"* %this)
    def f() {
        var a = A<T>();
        // CHECK-M: [[TMP:%[0-9]+]] = call %S @{{.*A.*S.*a.*}}({}* %a)
        // CHECK-M-NEXT: call void @_EN4main1S1iE(%S [[TMP]])
        a.a().i();
    }
}

def main() {
    var m = M<S>();
    m.f();
}
